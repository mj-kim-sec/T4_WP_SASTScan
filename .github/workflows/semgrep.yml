name: Semgrep

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]

permissions:
  contents: read
  security-events: write
  pull-requests: write

jobs:
  semgrep:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # (ë””ë²„ê·¸) ì‹¤ì œë¡œ ìŠ¤ìº”ë  PHP íŒŒì¼ í™•ì¸
      - name: List PHP files
        run: |
          echo "Repo root: $PWD"
          find . -type f -name "*.php" | head -n 200
          echo "Total PHP files:"
          find . -type f -name "*.php" | wc -l

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install Semgrep & jq
        run: |
          pip install --upgrade pip semgrep
          sudo apt-get update && sudo apt-get install -y jq

      # ì„¤ì • íŒŒì¼(.semgrep/.semgrep.yml â†’ .semgrep.yml â†’ auto) ê°ì§€ + ë¦¬í¬íŠ¸ í´ë” ì¤€ë¹„
      - name: Prepare config & reports dir
        shell: bash
        run: |
          set -e
          if [ -f ".semgrep/.semgrep.yml" ]; then
            CONFIG_FILE=".semgrep/.semgrep.yml"
          elif [ -f ".semgrep.yml" ]; then
            CONFIG_FILE=".semgrep.yml"
          else
            CONFIG_FILE="auto"
          fi
          echo "CONFIG=$CONFIG_FILE" >> "$GITHUB_ENV"
          mkdir -p reports

          echo "== CONFIG chosen =="
          echo "$CONFIG_FILE"

          echo "== List .semgrep dir (if any) =="
          ls -la .semgrep || true

          echo "== Show config (if file) =="
          if [ -f "$CONFIG_FILE" ]; then
            sed -n '1,200p' "$CONFIG_FILE"
          fi

      # JSON ì¶œë ¥ (ì—ëŸ¬ ìˆ¨ê¹€ ì—†ìŒ)
      - name: Semgrep JSON (debug mode)
        shell: bash
        run: |
          set -x
          echo "=== semgrep version ==="
          semgrep --version || true
          echo

          echo "=== pip package info ==="
          python -c "import pkgutil,sys; import semgrep,inspect; print('semgrep', semgrep.__version__)" || true
          echo

          echo "=== show CONFIG env ==="
          echo "CONFIG='$CONFIG'"
          echo

          echo "=== list .semgrep dir & files ==="
          ls -la .semgrep || true
          echo "=== list included rule files (if any) ==="
          if [ -f ".semgrep/.semgrep.yml" ]; then
            grep -n "include" -n .semgrep/.semgrep.yml || true
            sed -n '1,200p' .semgrep/.semgrep.yml || true
          fi
          echo

          echo "=== attempt semgrep dry-run with debug logging ==="
          mkdir -p reports
          # Run with --debug and capture both stdout & stderr to files so they appear in Actions log
          semgrep scan --config "$CONFIG" --metrics=off --timeout 10 --json -o reports/semgrep.json --debug 2>reports/semgrep-debug.err | tee reports/semgrep-debug.out
          RC=$?
          echo "semgrep exit code: $RC"
          echo "---- semgrep stdout (tail) ----"
          tail -n +1 reports/semgrep-debug.out || true
          echo "---- semgrep stderr (tail) ----"
          tail -n +1 reports/semgrep-debug.err || true

          if [ -s reports/semgrep.json ]; then
            echo "JSON produced with $(jq '.results | length' reports/semgrep.json) results"
          else
            echo "No JSON produced"
          fi
          # fail the step with the same rc so Actions will show failure (remove if you want it not to fail)
          exit $RC


      # SARIF ì¶œë ¥ (ì—ëŸ¬ ìˆ¨ê¹€ ì—†ìŒ)
      - name: Semgrep SARIF
        run: |
          set -e
          semgrep scan --config "$CONFIG" \
            --metrics=off --timeout 10 \
            --sarif -o reports/semgrep.sarif

      # GitHub Actions Job Summaryì— í•­ìƒ ìš”ì•½ ì¶œë ¥
      - name: Write Markdown Summary
        if: always()
        run: |
          echo "## ğŸ§ª Semgrep Summary" >> "$GITHUB_STEP_SUMMARY"

          if [ -s reports/semgrep.json ]; then
            TOTAL=$(jq '.results | length' reports/semgrep.json)
            echo "- Total findings: **$TOTAL**" >> "$GITHUB_STEP_SUMMARY"

            for sev in ERROR WARNING INFO; do
              COUNT=$(jq --arg sev "$sev" '[.results[] | select(.extra.severity==$sev)] | length' reports/semgrep.json)
              echo "  - $sev: **$COUNT**" >> "$GITHUB_STEP_SUMMARY"
            done

            echo -e "\n### Top findings (up to 10)\n" >> "$GITHUB_STEP_SUMMARY"
            jq -r '
              .results[]
              | {check_id, path: .path, start: .start.line, message: .extra.message, severity: .extra.severity}
              | "| \(.severity) | \(.check_id) | \(.path):\(.start) | \(.message | gsub("\\n"; " ")) |"
            ' reports/semgrep.json | head -n 10 >> "$GITHUB_STEP_SUMMARY"
          else
            echo "- Semgrep produced no JSON (likely no files matched). Check the **List PHP files** step above." >> "$GITHUB_STEP_SUMMARY"
          fi

      # Code Scanningì— SARIF ì—…ë¡œë“œ (íŒŒì¼ ìˆì„ ë•Œë§Œ)
      - name: Upload SARIF
        if: always() && hashFiles('reports/semgrep.sarif') != ''
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: reports/semgrep.sarif

      # ë¦¬í¬íŠ¸ íŒŒì¼ ë³´ì¡´(ë‹¤ìš´ë¡œë“œìš©)
      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: semgrep-reports
          path: reports/*
          if-no-files-found: warn
          retention-days: 14
